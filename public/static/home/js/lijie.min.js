var mainInfo;$.ajax({url:"index.php/index/index/getMainInfo",success:function(a){mainInfo=JSON.parse(a)[0]}});var spriteArr=[];const vecBei=new THREE.Vector3(0,0,-1);function init(){scene=new THREE.Scene,camera=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,.1,1e3),scene.add(camera),camera.position.set(-40,9.5,42),camera.lookAt(new THREE.Vector3(0,8,0)),renderer=new THREE.WebGLRenderer,renderer.setSize(window.innerWidth*devicePixelRatio,window.innerHeight*devicePixelRatio),renderer.domElement.style.width=window.innerWidth+"px",renderer.domElement.style.height=window.innerHeight+"px",document.body.appendChild(renderer.domElement),renderer.setClearColor(new THREE.Color(10671100));var a=new THREE.GLTFLoader;a.load("static/home/gltf/main.glb",function(a){console.log("\u52A0\u8F7Dgltf\u6210\u529F"),scene.add(a.scene)},void 0,function(a){console.log(a)});var b=new THREE.AmbientLight(16777215,1);scene.add(b);var c=new THREE.PointLight(16777215);c.position.set(0,50,30),scene.add(c);var c=new THREE.PointLight(16777215);c.position.set(0,12,30),scene.add(c);var d=new THREE.Fog(10671100,60,200);scene.fog=d;var e=new THREE.PlaneGeometry(1e3,1e3,1),f=new THREE.MeshBasicMaterial({color:14417805,side:THREE.DoubleSide}),g=new THREE.Mesh(e,f);g.rotateX(Math.PI/2),g.position.y-=2,scene.add(g)}init();var sceneArr;function getNewIntro(a){sceneArr=JSON.parse(a);for(var b=0;b<sceneArr.length;b++){var c=new THREE.TextureLoader().load(sceneArr[b].SCENE_SPRITE_MAP),d=new THREE.SpriteMaterial({map:c,color:16777215});sceneArr[b].ID==$("#sceneName").data("sceneid")&&(d.color=new THREE.Color(1,.3,0)),d.depthTest=!1;var e=new THREE.Sprite(d);spriteArr.push(e);var f=JSON.parse(sceneArr[b].POSITION);e.sceneID=sceneArr[b].ID,e.NAME=sceneArr[b].NAME,e.PIC_ADD=sceneArr[b].PIC_ADD,e.SCENE_SPRITE_MAP=sceneArr[b].SCENE_SPRITE_MAP,e.TEXT_INTRODUCTION=sceneArr[b].TEXT_INTRODUCTION,e.VOICE_ADD=sceneArr[b].VOICE_ADD,e.position.set(f.x,f.y,f.z),scene.add(e)}for(var b in sceneArr)0!=sceneArr[b].ID&&($("#start").append("<option value='"+sceneArr[b].POSITION+"'>"+sceneArr[b].NAME+"</option>"),$("#end").append("<option value='"+sceneArr[b].POSITION+"'>"+sceneArr[b].NAME+"</option>"))}$.ajax({url:"index.php/index/index/getScene",success:function(a){getNewIntro(a)}});var raycaster=new THREE.Raycaster,mouse=new THREE.Vector2;function rayCastFromCamera(a){mouse.x=2*(a.touches[0].clientX/window.innerWidth)-1,mouse.y=2*-(a.touches[0].clientY/window.innerHeight)+1,raycaster.setFromCamera(mouse,camera);var b=raycaster.intersectObjects(scene.children);if(b[0]&&b[0].object.NAME){isOn=!1;var c=b[0].object;$("#sceneName").text(c.NAME),$("#scenePic").attr("src",c.PIC_ADD),$("#textIntroduction").html(c.TEXT_INTRODUCTION),$("#sceneVoice").attr("src",c.VOICE_ADD),$("#inTroLayer").show(),$("#sceneVoice")[0].load(),$("#voiceCtl img").attr("src","static/home/img/audio0.png")}}renderer.domElement.addEventListener("touchstart",rayCastFromCamera,!1);function ren(){renderer.render(scene,camera),requestAnimationFrame(ren)}ren();var control=new THREE.OrbitControls(camera,document.getElementsByTagName("canvas")[0]);control.maxDistance=80,control.minDistance=20,control.maxPolarAngle=Math.PI/2-.1,window.onresize=function(){renderer.setSize(window.innerWidth*devicePixelRatio,window.innerHeight*devicePixelRatio),renderer.domElement.style.width=window.innerWidth+"px",renderer.domElement.style.height=window.innerHeight+"px"},$.ajax({url:"index.php/index/index/checkPageView",success:function(a){var b=JSON.parse(a);$("#viewNum").html("\u4ECA\u65E5\u8BBF\u95EE:"+b.todayNum+"&nbsp&nbsp&nbsp&nbsp\u8BBF\u95EE\u603B\u91CF:"+b.totalNum)}});function shutDownIntro(){$("#inTroLayer").slideToggle(100)}function showIntro(){$("#sceneName").text(mainInfo.NAME),$("#textIntroduction").html(mainInfo.TEXT_INTRODUCTION),$("#sceneVoice").attr("src",mainInfo.VOICE_ADD),$("#scenePic").attr("src",mainInfo.PIC_ADD),$("#sceneVoice")[0].load(),$("#voiceCtl img").attr("src","static/home/img/audio0.png"),$("#inTroLayer").slideToggle(100)}function derc(){var a=new THREE.Vector3(camera.position.x,0,camera.position.z),b=vecBei.angleTo(a),c=a.dot(vecBei),d=Math.ceil(180*b/Math.PI),e=0<=camera.position.x?180-d:d-180;$("#drec").css("transform","rotate("+e+"deg)")}$("canvas").on("touchmove",derc);function setSpriteScale(){for(var a in spriteArr){var b=spriteArr[a].position.distanceTo(camera.position);spriteArr[a].scale.set(b/10,b/20,1)}}document.body.addEventListener("touchstart",setSpriteScale),document.body.addEventListener("mousemove",setSpriteScale);var currentPoints;function getPoints(){mouse.x=2*(event.clientX/window.innerWidth)-1,mouse.y=2*-(event.clientY/window.innerHeight)+1,raycaster.setFromCamera(mouse,camera);var a=raycaster.intersectObjects(scene.getObjectByName("Scene").children);a[0]&&(console.log("\u70B9\u51FB\u7684\u4F4D\u7F6E\u662F\uFF1A",a[0].point),currentPoints=a[0].point)}renderer.domElement.addEventListener("click",getPoints);var u=navigator.userAgent,app=navigator.appVersion,isIOS=!!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/);$(document).ready(function(){$("select").blur(function(){isIOS&&blurAdjust()})});function blurAdjust(){setTimeout(()=>{if("select"==document.activeElement.tagName)return;let a="pc";/(iPhone|iPad|iPod|iOS)/i.test(navigator.userAgent)?a="ios":/(Android)/i.test(navigator.userAgent)&&(a="android"),(a="ios")&&document.activeElement.scrollIntoViewIfNeeded(!0)},100)}$("#daohang").on("touchstart",function(){$("#luxian").slideToggle(100)});var graph,lastLuMesh,PointsToGraphArr=[],PointsArr=[];$.ajax({url:"index.php/index/index/getMapdata",success:function(a){graph=new Graph(JSON.parse(a[0].data),{diagonal:!0}),PointsArr=JSON.parse(a[1].data),PointsToGraphArr=JSON.parse(a[2].data)}}),$("#pointsgetbutton").click(function(){var a={pos:currentPoints,u:$("#u").val(),v:$("#v").val()};$("#u").val()&&$("#v").val()&&(PointsArr.push(a),PointsToGraphArr[a.u][a.v]=currentPoints),$("#info").text("\u70B9\u51FB\u7ED3\u679C\uFF1A"+JSON.stringify(a))});function zuijingdian(a,b){for(var c,d=1e4,e=0;e<b.length;e+=1)d>a.distanceTo(b[e].pos)&&(d=a.distanceTo(b[e].pos),c=e);return b[c]}$("#luxianbutton").on("touchstart",function(){$("#luxian").slideToggle(100);var a=JSON.parse($("#start").val()),b=JSON.parse($("#end").val());a=new THREE.Vector3(+a.x,+a.y,+a.z),b=new THREE.Vector3(+b.x,+b.y,+b.z);var c=zuijingdian(a,PointsArr),d=zuijingdian(b,PointsArr),e=graph.grid[c.u][c.v],f=graph.grid[d.u][d.v],g=astar.search(graph,e,f),h=[];if(g){for(var j in h.push(a),g){var i=PointsToGraphArr[g[j].x][g[j].y];h.push(new THREE.Vector3(i.x,i.y,i.z))}h.push(b)}console.log(h),creatLu(h)});var lastintervalId;function creatLu(a){clearInterval(lastintervalId),scene.remove(lastLuMesh);var b=new THREE.CatmullRomCurve3(a),c=b.getPoints(30),d=new THREE.SphereBufferGeometry(.5,32,32),e=new THREE.MeshBasicMaterial({color:16711680});console.log(c),lastLuMesh=new THREE.Mesh(d,e),scene.add(lastLuMesh);var f=0;lastintervalId=setInterval(function(){f<c.length?(lastLuMesh.position.set(c[f].x,c[f].y+.5,c[f].z),f++):f=0},100)}$("#voiceCtl").on("touchstart",function(){$("#sceneVoice")[0].paused?(console.log("\u64AD\u653E"),$("#sceneVoice")[0].play(),$("#voiceCtl img").attr("src","static/home/img/audio.png")):(console.log("\u6682\u505C"),$("#sceneVoice")[0].pause(),$("#voiceCtl img").attr("src","static/home/img/audio0.png"))}),$("#smallLogo").on("dblclick",function(){$("#pointsget").toggle()}),$("#drec").on("touchstart",function(){camera.position.set(-40,9.5,42),camera.lookAt(scene.position),derc()});